# RTK Query OpenAPI Code Generator Known Issue

## Problem

The `bun run gen` command (which runs `rtk-query-codegen-openapi`) fails with a TypeScript error:

```
TypeError: undefined is not an object (evaluating 'node.elements.end')
  at emitTupleType
```

## Root Cause

The RTK Query OpenAPI code generator cannot handle tuple types (e.g., `type: ['array', 'null']`) that are generated in the OpenAPI specification.

These tuple types are generated by Huma framework when Go slice/array fields can be `nil`. The correct OpenAPI 3.0 way would be to use `nullable: true`, but Huma generates tuple types instead.

## Current Workaround

When adding new API endpoints or fields:

1. Run `cd backend && make gen` to regenerate the OpenAPI spec
2. **Manually update** `frontend/src/store/sratApi.ts` with new types and endpoints
3. The frontend build (`bun run build`) will work fine with manual updates

## Example Manual Updates

When adding a new endpoint like `/api/capabilities`:

```typescript
// 1. Add the endpoint query
getApiCapabilities: build.query<
  GetApiCapabilitiesApiResponse,
  GetApiCapabilitiesApiArg
>({
  query: () => ({ url: `/api/capabilities` }),
  providesTags: ["system"],
}),

// 2. Add the response/arg types
export type GetApiCapabilitiesApiResponse = /** status 200 OK */
  | SystemCapabilities
  | /** status default Error */ ErrorModel;
export type GetApiCapabilitiesApiArg = void;

// 3. Add any new DTO types
export type SystemCapabilities = {
  supports_quic: boolean;
};

// 4. Add to exports
export const {
  // ... other hooks
  useGetApiCapabilitiesQuery,
  // ...
} = sratApi;
```

## Affected Schemas

The following schemas currently have tuple types (as of Oct 2024):

- `Settings.mountoptions`
- `FilesystemType.customMountFlags`
- `FilesystemType.mountFlags`
- `SharedResource.ro_users`
- `SharedResource.users`
- Many response arrays (filesystems, issues, shares, users, volumes, etc.)

## Long-term Solution

To fix this properly would require:

1. Either upgrading to OpenAPI 3.1 (which natively supports null as a type)
2. Or modifying Huma or the OpenAPI generation to use `nullable: true` instead of tuple types
3. Or finding/creating an alternative code generator that handles tuple types

This is a codebase-wide issue that affects many endpoints, not just the SMB over QUIC feature.

## Verification

Even though `bun gen` fails, you can verify the generated OpenAPI spec is correct:

```bash
cd backend && make gen
# Check specific fields
cat docs/openapi.json | jq '.components.schemas.Settings.properties.smb_over_quic'
```

And verify the frontend builds:

```bash
cd frontend && bun run build
```

## Related Issues

- This is a known limitation of the `@rtk-query/codegen-openapi` package when dealing with tuple types
- See: https://github.com/rtk-incubator/rtk-query-codegen-openapi/issues (various tuple type issues)
