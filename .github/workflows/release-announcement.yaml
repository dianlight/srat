name: Create Release Announcement

on:
  release:
    types: [published]

permissions:
  # Required to create a discussion
  discussions: write

jobs:
  create_discussion:
    name: Create Announcement Discussion
    runs-on: ubuntu-latest
    # This condition ensures we only create announcements for full, stable releases.
    # Remove this 'if' condition if you want to announce pre-releases as well.
    if: github.event.release.prerelease == false
    steps:
      - name: Create GitHub Discussion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          # Construct discussion content
          TITLE="ðŸŽ‰ New Release: ${RELEASE_NAME}"
          BODY="## ${RELEASE_NAME} has been released!

          You can find the full release notes and download the assets here:
          >${RELEASE_URL}

          ---

          ${RELEASE_BODY}"

          # Check if version is dev or RC and adjust title/body
          if [[ "$RELEASE_NAME" =~ -dev\. ]]; then
            TITLE="ðŸš€ Development Release: ${RELEASE_NAME}"
            BODY="## ${RELEASE_NAME} Development Release

          âš ï¸ **This is a development release** â€“ it may contain experimental features and is not recommended for production use.

          You can find the full release notes and download the assets here:
          >${RELEASE_URL}

          ---

          ${RELEASE_BODY}"
            elif [[ "$RELEASE_NAME" =~ -rc\. ]]; then
            TITLE="ðŸ§ª Release Candidate: ${RELEASE_NAME}"
            BODY="## ${RELEASE_NAME} Release Candidate

          âš ï¸ **This is a release candidate** â€“ please test and report any issues before the stable release.

          You can find the full release notes and download the assets here:
          >${RELEASE_URL}

          ---

          ${RELEASE_BODY}"
          fi

          # Get the repository ID
          REPO_ID=$(gh api repos/$GH_REPO --jq '.id')
          
          # Get the Announcements category ID (adjust if your category has a different name)
          CATEGORY_ID=$(gh api repos/$GH_REPO/discussion-categories --jq '.[] | select(.name=="Announcements") | .id')

          # Create discussion via GraphQL API
          gh api graphql -f owner="${GH_REPO%/*}" -f repo="${GH_REPO#*/}" -f title="$TITLE" -f body="$BODY" -f categoryId="$CATEGORY_ID" << 'EOF'
          mutation($owner: String!, $repo: String!, $title: String!, $body: String!, $categoryId: String!) {
            createDiscussion(input: {repositoryId: "R_$repo", title: $title, body: $body, categoryId: $categoryId}) {
              discussion {
                id
                url
              }
            }
          }
          EOF
